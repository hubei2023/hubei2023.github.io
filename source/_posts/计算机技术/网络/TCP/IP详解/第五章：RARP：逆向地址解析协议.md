---
title: "《IP详解》-第五章：RARP：逆向地址解析协议"
date: 2024-10-31
tags: 
---
在《TCP/IP详解 卷1：协议》的第五章“RARP：逆向地址解析协议”中，W. Richard Stevens 介绍了 RARP（Reverse Address Resolution Protocol，逆向地址解析协议）的原理、工作机制及其局限性。RARP 是一种较早用于网络设备自配置的协议，主要用于从已知的物理地址（MAC 地址）获取对应的 IP 地址，以下是该章的详细介绍：

### 5.1 RARP 协议概述
RARP 的基本功能是将设备的物理地址（MAC 地址）映射到网络层的 IP 地址。RARP 是一种无连接、低级别的协议，通常用于无盘工作站（diskless workstation）等需要动态获取 IP 地址的设备。无盘工作站启动时只知道自己的 MAC 地址，但不知道 IP 地址，RARP 允许它们在不输入配置的情况下从 RARP 服务器获取一个 IP 地址，从而加入网络。

### 5.2 RARP 的工作原理
RARP 使用客户端-服务器模式，典型的工作流程如下：
1. **RARP 请求**：当设备（如无盘工作站）启动后，它会向网络广播一个 RARP 请求，包含自己的 MAC 地址，目的是请求 IP 地址。
2. **RARP 响应**：网络中的 RARP 服务器接收到请求后，查找该 MAC 地址对应的 IP 地址，并返回给请求设备。

RARP 请求和响应均为数据链路层帧，与 ARP 类似，但其中的字段稍有不同。通常，RARP 是在局域网内使用，因为 RARP 不支持跨网段的 IP 地址请求。

### 5.3 RARP 数据包格式
RARP 使用与 ARP 相同的数据帧格式，但在操作码字段中指定操作类型（请求或响应）不同。RARP 数据帧的主要字段包括：
- **硬件类型**：指链路层的硬件类型（通常为以太网）。
- **协议类型**：指上层协议类型（IPv4 使用 0x0800）。
- **硬件地址长度**：指物理地址的长度（MAC 地址长度为 6 字节）。
- **协议地址长度**：指 IP 地址的长度（IPv4 地址长度为 4 字节）。
- **操作码**：标明请求（3）或响应（4）。
- **发送方硬件地址**和**发送方协议地址**：发送方的 MAC 地址和 IP 地址（在请求中 IP 地址为空）。
- **目标硬件地址**和**目标协议地址**：目标设备的 MAC 地址和请求的 IP 地址（在请求中 IP 地址为空）。

RARP 请求中，目标协议地址（即 IP 地址）为空，而 RARP 响应中则填入对应的 IP 地址。RARP 数据包通常封装在链路层帧中，借助 MAC 地址进行广播传输。

### 5.4 RARP 服务器
**RARP 服务器** 是 RARP 协议的关键角色，它们通过查询 MAC 地址与 IP 地址的映射表，为请求设备提供 IP 地址。通常，一个局域网内会配置多个 RARP 服务器以提高可靠性。RARP 服务器的特性如下：
- **MAC-IP 映射表**：RARP 服务器维护一张表格，存储每个 MAC 地址与对应的 IP 地址。
- **响应机制**：当收到 RARP 请求时，服务器会查询映射表，并将对应的 IP 地址封装到 RARP 响应中返回。
- **静态配置**：RARP 服务器的 MAC-IP 映射表通常是静态配置的，意味着需要管理员手动维护。

因为 RARP 服务器需要手动维护 MAC 和 IP 地址的映射，所以管理成本较高，且不适合大规模部署。

### 5.5 RARP 的局限性
虽然 RARP 在早期网络中曾被广泛应用，但它存在多个局限性，使其逐渐被更先进的协议（如 BOOTP 和 DHCP）取代：
- **不支持跨网段**：RARP 只能在本地局域网中使用，不能跨越路由器进行 IP 地址分配，这限制了它的应用范围。
- **单一功能**：RARP 仅能提供 IP 地址，无法像 BOOTP 和 DHCP 那样提供子网掩码、网关、DNS 服务器等额外的网络配置参数。
- **配置复杂**：RARP 服务器的 MAC-IP 映射需要手动配置并维护，特别是随着网络规模的扩大，维护成本变得更高。
- **可靠性差**：RARP 依赖广播的方式发送请求和接收响应，容易受到网络延迟和拥塞的影响。此外，如果局域网中没有 RARP 服务器，设备将无法获得 IP 地址。

### 5.6 RARP 与 ARP 的区别
ARP 和 RARP 虽然在功能上存在相似之处，但其工作方向和目的不同：
- **ARP**：用于将 IP 地址解析成 MAC 地址，即已知 IP 地址，查找物理地址。典型应用是数据帧在局域网内的传输。
- **RARP**：用于将 MAC 地址解析成 IP 地址，即已知物理地址，查找 IP 地址。典型应用是无盘工作站启动时获取 IP 地址。

ARP 和 RARP 都是链路层协议，且数据包格式几乎相同，但由于方向和应用场景的不同，功能和配置也有差异。

### 5.7 RARP 的替代方案：BOOTP 和 DHCP
RARP 的局限性导致其在现代网络中逐渐被替代，BOOTP（Bootstrap Protocol）和 DHCP（Dynamic Host Configuration Protocol）成为其主要替代方案：
- **BOOTP**：是一种基于 UDP 的协议，BOOTP 不仅可以为设备分配 IP 地址，还能提供其他网络配置信息（如网关和子网掩码）。BOOTP 支持跨网段的地址分配，因为 BOOTP 消息可以被路由器转发。
- **DHCP**：是一种动态主机配置协议，基于 BOOTP 发展而来。DHCP 具有更高的灵活性，支持动态分配 IP 地址，可以为大量设备自动分配 IP 地址，并动态管理地址池。DHCP 还可以提供 DNS、WINS 等多种网络参数。

相比 RARP，BOOTP 和 DHCP 更适合现代网络中的设备管理，特别是在需要动态分配和大规模管理 IP 地址的场景中。

### 5.8 RARP 的应用场景
尽管 RARP 在现代网络中已较少使用，但在一些特定的网络环境或老旧系统中，它仍然可能被使用，尤其是早期的无盘工作站或嵌入式设备中：
- **无盘工作站**：RARP 最初主要用于无盘工作站。无盘工作站在启动时只能访问自身的 MAC 地址，通过 RARP 可获得 IP 地址并加载系统。
- **嵌入式设备**：部分早期嵌入式设备可能依赖 RARP 获取网络地址信息，尤其是在无法配置 BOOTP 或 DHCP 服务的网络环境中。
- **旧式网络环境**：在某些老式局域网和特定的网络设备中，可能仍保留对 RARP 的支持，以确保兼容性。

### 5.9 RARP 的操作示例
虽然现代网络中不再普遍使用 RARP，但理解其操作流程对学习网络协议有所帮助。RARP 请求和响应过程如下：
1. 无盘工作站启动，发送一个包含自身 MAC 地址的 RARP 请求数据包，目的 MAC 地址为局域网广播地址。
2. 局域网中的 RARP 服务器接收到请求，查询 MAC 地址映射表，找到对应的 IP 地址。
3. RARP 服务器将 IP 地址封装在 RARP 响应数据包中，并发送回请求的设备。
4. 无盘工作站接收响应数据包后，提取其中的 IP 地址，用于后续的网络通信。

---

### 总结
第五章深入介绍了 RARP 的基本原理、数据包格式、工作流程及其局限性。RARP 曾是网络设备获取 IP 地址的一种简单方法，尤其适用于无盘工作站和早期嵌入式设备。然而，由于 RARP 无法提供跨网段传输，且功能较为单一，因此在现代网络中已被更为灵活的 BOOTP 和 DHCP 协议所取代。通过学习 RARP 的工作机制，可以更好地理解早期网络自配置方法的发展历程，并为理解后续的动态 IP 配置协议打下基础。
